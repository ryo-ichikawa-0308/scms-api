# API実装ルール

## 前提

- NestJS及びPrismaを使用する。
- `schema.prisma`は、DB定義書をAI処理して作成したものを用いる。
- APIの実装コードは、API設計書をAI処理して作成したスケルトンコードに、ビジネスロジックを記述することで実装する。

## フォルダ構成

API実装コードは、エンタープライズアーキテクチャに基づき、下記のフォルダ構成で実装する。

- `src`
  - `domain`
    - エンドポイントとなるコントローラクラスと、登録・更新系APIのトランザクション管理を行うオーケストレーションクラスを格納する。
      - リクエスト・レスポンスに特定のオブジェクト型が定義されている場合、DTOをAIによって作成済みである。
      - コントローラクラスはAIによって作成済みであり、API定義書と厳密に紐づくため人手で更新してはならない。
      - オーケストレーションクラスはスケルトンコードをAIによって作成済みである。ビジネスロジックの呼び出しとエラーハンドリングを人手で実装する。
    - 各ドメインコンテキストごとにフォルダ分けされ、`DomainContextModule`モジュールとして、外部に機能を提供する。
  - `service`
    - ビジネスロジックを実装した、下記3種類のサービスクラスを格納する。
      - コントローラークラスから呼び出されてデータ取得のビジネスロジックを提供するサービスクラス。
      - オーケストレーションクラスから呼び出されて登録・更新・削除(論理削除)のビジネスロジックを提供するサービスクラス。
      - DB処理と紐づかない機能(メール送信など)を提供するサービスクラス。
    - いずれもスケルトンコードをAIによって作成済みである。ビジネスロジックとエラーハンドリングを人手で実装する。
    - `domain`層のDTOと`database`層のDTOは、`service`のビジネスロジックによって詰め替えを行う。
    - ビジネスロジックは、機能コンテキストごとにフォルダ分けされ、`ServiceContextModule`モジュールとして、`domain`層のモジュールに機能を提供する。
  - `database`
    - DBのテーブルと1:1で紐づくDAO及びDTOを格納する。
    - DAOは基本的なメソッド(単純SELECT、単純COUNT、INSERT、UPDATE、SOFT-DELETE、DELETE)をAIによって作成済みである。テーブル結合を含む複雑なSELECTのみ、人手で実装する。
    - DTOは単純SELECT用DTO、INSERT用DTOをAIによって作成済みである。テーブル結合を含むSELECTのDTOは、SELECTの軸になるテーブルのDTOに実装する(後述)。
    - すべてのDAOを纏めて、`DataAccessModule`モジュールとして`service`層のモジュールに機能を提供する。
  - `prisma`
    - `schema.prisma`を格納する。
    - Prisma接続サービスを`PrismaModule`モジュールとして`database`層のモジュールに機能を提供する。
    - `PrismaModule`モジュールは、`domain`層のオーケストレーションクラスに、トランザクション機能を提供する役割も持つ。
